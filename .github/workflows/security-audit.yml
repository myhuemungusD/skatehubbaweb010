name: Security Audit

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Detect package manager
        id: pm
        run: |
          if [ -f pnpm-lock.yaml ]; then 
            echo "pm=pnpm" >> $GITHUB_OUTPUT
          else 
            echo "pm=npm" >> $GITHUB_OUTPUT
          fi

      - name: Setup pnpm
        if: steps.pm.outputs.pm == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: |
          if [ "${{ steps.pm.outputs.pm }}" = "pnpm" ]; then
            pnpm install --no-frozen-lockfile
          else
            npm ci
          fi

      - name: Run npm audit (production)
        id: npm_audit
        continue-on-error: true
        run: |
          echo "## NPM Audit Results (Production Dependencies)" > audit-report.md
          echo "" >> audit-report.md
          
          # Run audit and capture output
          if npm audit --production --json > audit-results.json 2>&1; then
            echo "âœ… No vulnerabilities found in production dependencies" >> audit-report.md
            echo "status=success" >> $GITHUB_OUTPUT
          else
            # Parse JSON results and create summary
            if [ -f audit-results.json ]; then
              echo "### Vulnerability Summary" >> audit-report.md
              echo "" >> audit-report.md
              
              # Extract counts using jq if available, otherwise use grep
              if command -v jq &> /dev/null; then
                critical=$(jq -r '.metadata.vulnerabilities.critical // 0' audit-results.json)
                high=$(jq -r '.metadata.vulnerabilities.high // 0' audit-results.json)
                moderate=$(jq -r '.metadata.vulnerabilities.moderate // 0' audit-results.json)
                low=$(jq -r '.metadata.vulnerabilities.low // 0' audit-results.json)
                
                echo "- ðŸ”´ Critical: $critical" >> audit-report.md
                echo "- ðŸŸ  High: $high" >> audit-report.md
                echo "- ðŸŸ¡ Moderate: $moderate" >> audit-report.md
                echo "- ðŸŸ¢ Low: $low" >> audit-report.md
              else
                npm audit --production >> audit-report.md 2>&1 || true
              fi
              
              echo "" >> audit-report.md
              echo "Run \`npm audit fix\` to attempt automatic fixes." >> audit-report.md
            else
              echo "âš ï¸ Could not generate detailed audit report" >> audit-report.md
            fi
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
          
          echo "" >> audit-report.md

      - name: Check for exposed API keys and secrets
        id: secret_scan
        continue-on-error: true
        run: |
          echo "## API Key and Secret Detection" >> audit-report.md
          echo "" >> audit-report.md
          
          # Create patterns file for secret detection
          cat > secret-patterns.txt << 'EOF'
          AIzaSy[0-9A-Za-z_-]{33}
          sk_live_[0-9a-zA-Z]{24,}
          sk_test_[0-9a-zA-Z]{24,}
          pk_live_[0-9a-zA-Z]{24,}
          pk_test_[0-9a-zA-Z]{24,}
          [0-9]+-[0-9A-Za-z_]{32}\.apps\.googleusercontent\.com
          ya29\.[0-9A-Za-z\-_]+
          AKIA[0-9A-Z]{16}
          sk-[a-zA-Z0-9]{48}
          ghp_[0-9a-zA-Z]{36}
          github_pat_[0-9a-zA-Z_]{82}
          glpat-[0-9a-zA-Z\-_]{20}
          EOF
          
          found=0
          
          # Search in source files (excluding node_modules, dist, .git)
          echo "### Searching for exposed secrets in source files..." >> audit-report.md
          echo "" >> audit-report.md
          
          while IFS= read -r pattern; do
            matches=$(grep -rn -E "$pattern" \
              --exclude-dir={node_modules,dist,.git,build,coverage,.next} \
              --exclude={package-lock.json,pnpm-lock.yaml,yarn.lock,*.min.js,*.map} \
              . 2>/dev/null || true)
            
            if [ -n "$matches" ]; then
              echo "âš ï¸ **Potential secret found:**" >> audit-report.md
              echo '```' >> audit-report.md
              echo "$matches" | head -10 >> audit-report.md
              echo '```' >> audit-report.md
              echo "" >> audit-report.md
              found=1
            fi
          done < secret-patterns.txt
          
          # Check for hardcoded Firebase config in JS/TS files
          echo "### Checking for Firebase config leaks..." >> audit-report.md
          echo "" >> audit-report.md
          
          firebase_config_files=$(grep -rn "firebaseConfig\|firebase.initializeApp" \
            --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" \
            --exclude-dir={node_modules,dist,.git} \
            . 2>/dev/null | grep -v ".example\|EXAMPLE" || true)
          
          if [ -n "$firebase_config_files" ]; then
            echo "âš ï¸ **Firebase configuration found in source files:**" >> audit-report.md
            echo '```' >> audit-report.md
            echo "$firebase_config_files" | head -10 >> audit-report.md
            echo '```' >> audit-report.md
            echo "" >> audit-report.md
            echo "âœ… Verify these configs use environment variables (VITE_FIREBASE_*)" >> audit-report.md
            echo "" >> audit-report.md
          fi
          
          # Check .env file is not committed
          if git ls-files | grep -q "^\.env$"; then
            echo "ðŸ”´ **CRITICAL: .env file is committed to git!**" >> audit-report.md
            echo "This file may contain secrets. Remove it immediately:" >> audit-report.md
            echo '```bash' >> audit-report.md
            echo 'git rm --cached .env' >> audit-report.md
            echo 'git commit -m "Remove .env from git"' >> audit-report.md
            echo '```' >> audit-report.md
            echo "" >> audit-report.md
            found=1
          fi
          
          if [ $found -eq 0 ]; then
            echo "âœ… No exposed API keys or secrets detected in source files" >> audit-report.md
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "" >> audit-report.md
            echo "âš ï¸ **Action Required:** Review the findings above and ensure no real secrets are exposed." >> audit-report.md
            echo "status=warning" >> $GITHUB_OUTPUT
          fi
          
          echo "" >> audit-report.md

      - name: OWASP Top 10 Compliance Check
        id: owasp_check
        continue-on-error: true
        run: |
          echo "## OWASP Top 10 Compliance Analysis" >> audit-report.md
          echo "" >> audit-report.md
          
          # Initialize counters
          issues=0
          
          # A01:2021 - Broken Access Control
          echo "### A01:2021 - Broken Access Control" >> audit-report.md
          
          # Check for authentication middleware
          if grep -rq "requireAuth\|isAuthenticated\|verifyToken" server/ 2>/dev/null; then
            echo "âœ… Authentication middleware found" >> audit-report.md
          else
            echo "âš ï¸ No authentication middleware detected" >> audit-report.md
            issues=$((issues + 1))
          fi
          
          # Check for authorization checks
          if grep -rq "req.user\|req.session" server/ 2>/dev/null; then
            echo "âœ… User session/context usage found" >> audit-report.md
          else
            echo "âš ï¸ Limited user session usage detected" >> audit-report.md
          fi
          echo "" >> audit-report.md
          
          # A02:2021 - Cryptographic Failures
          echo "### A02:2021 - Cryptographic Failures" >> audit-report.md
          
          # Check for HTTPS enforcement
          if grep -rq "helmet\|secure.*cookie" server/ 2>/dev/null; then
            echo "âœ… Security headers (helmet) detected" >> audit-report.md
          else
            echo "âš ï¸ Consider using helmet for security headers" >> audit-report.md
            issues=$((issues + 1))
          fi
          
          # Check for password hashing
          if grep -rq "bcrypt\|argon2\|scrypt" server/ package.json 2>/dev/null; then
            echo "âœ… Password hashing library found" >> audit-report.md
          else
            echo "â„¹ï¸ No password hashing detected (may use external auth)" >> audit-report.md
          fi
          echo "" >> audit-report.md
          
          # A03:2021 - Injection
          echo "### A03:2021 - Injection" >> audit-report.md
          
          # Check for SQL injection protection
          if grep -rq "drizzle\|prisma\|sequelize" server/ package.json 2>/dev/null; then
            echo "âœ… ORM detected (helps prevent SQL injection)" >> audit-report.md
          else
            echo "âš ï¸ No ORM detected - ensure parameterized queries are used" >> audit-report.md
            issues=$((issues + 1))
          fi
          
          # Check for input validation
          if grep -rq "zod\|joi\|validator" server/ package.json 2>/dev/null; then
            echo "âœ… Input validation library found" >> audit-report.md
          else
            echo "âš ï¸ No input validation library detected" >> audit-report.md
            issues=$((issues + 1))
          fi
          echo "" >> audit-report.md
          
          # A04:2021 - Insecure Design
          echo "### A04:2021 - Insecure Design" >> audit-report.md
          
          # Check for rate limiting
          if grep -rq "express-rate-limit\|rate.*limit" server/ package.json 2>/dev/null; then
            echo "âœ… Rate limiting detected" >> audit-report.md
          else
            echo "âš ï¸ No rate limiting detected" >> audit-report.md
            issues=$((issues + 1))
          fi
          echo "" >> audit-report.md
          
          # A05:2021 - Security Misconfiguration
          echo "### A05:2021 - Security Misconfiguration" >> audit-report.md
          
          # Check for CORS configuration
          if grep -rq "cors" server/ package.json 2>/dev/null; then
            echo "âœ… CORS configuration found" >> audit-report.md
          else
            echo "âš ï¸ No CORS configuration detected" >> audit-report.md
          fi
          
          # Check for CSP
          if grep -rq "contentSecurityPolicy\|helmet.*csp" server/ 2>/dev/null; then
            echo "âœ… Content Security Policy detected" >> audit-report.md
          else
            echo "âš ï¸ No CSP detected - consider implementing" >> audit-report.md
            issues=$((issues + 1))
          fi
          
          # Check for security headers
          if grep -rq "helmet" server/ package.json 2>/dev/null; then
            echo "âœ… Helmet middleware for security headers" >> audit-report.md
          else
            echo "âš ï¸ Helmet not detected" >> audit-report.md
            issues=$((issues + 1))
          fi
          echo "" >> audit-report.md
          
          # A06:2021 - Vulnerable and Outdated Components
          echo "### A06:2021 - Vulnerable and Outdated Components" >> audit-report.md
          echo "See NPM Audit section above for details" >> audit-report.md
          echo "" >> audit-report.md
          
          # A07:2021 - Identification and Authentication Failures
          echo "### A07:2021 - Identification and Authentication Failures" >> audit-report.md
          
          # Check for session management
          if grep -rq "express-session" server/ package.json 2>/dev/null; then
            echo "âœ… Session management library found" >> audit-report.md
          else
            echo "â„¹ï¸ No express-session detected (may use JWT or Firebase)" >> audit-report.md
          fi
          
          # Check for JWT
          if grep -rq "jsonwebtoken\|jwt" server/ package.json 2>/dev/null; then
            echo "âœ… JWT library found" >> audit-report.md
          else
            echo "â„¹ï¸ No JWT library detected" >> audit-report.md
          fi
          echo "" >> audit-report.md
          
          # A08:2021 - Software and Data Integrity Failures
          echo "### A08:2021 - Software and Data Integrity Failures" >> audit-report.md
          
          # Check for package lock file
          if [ -f "package-lock.json" ] || [ -f "pnpm-lock.yaml" ] || [ -f "yarn.lock" ]; then
            echo "âœ… Package lock file exists (ensures dependency integrity)" >> audit-report.md
          else
            echo "âš ï¸ No package lock file found" >> audit-report.md
            issues=$((issues + 1))
          fi
          echo "" >> audit-report.md
          
          # A09:2021 - Security Logging and Monitoring Failures
          echo "### A09:2021 - Security Logging and Monitoring Failures" >> audit-report.md
          
          # Check for logging
          if grep -rq "winston\|pino\|morgan\|logger" server/ package.json 2>/dev/null; then
            echo "âœ… Logging library detected" >> audit-report.md
          else
            echo "âš ï¸ No dedicated logging library detected" >> audit-report.md
            issues=$((issues + 1))
          fi
          
          # Check for monitoring/error tracking
          if grep -rq "sentry\|datadog\|newrelic" server/ package.json 2>/dev/null; then
            echo "âœ… Error monitoring/tracking detected" >> audit-report.md
          else
            echo "â„¹ï¸ No error monitoring detected" >> audit-report.md
          fi
          echo "" >> audit-report.md
          
          # A10:2021 - Server-Side Request Forgery (SSRF)
          echo "### A10:2021 - Server-Side Request Forgery (SSRF)" >> audit-report.md
          
          # Check for SSRF protection patterns
          if grep -rq "axios\|fetch\|request\|http.get" server/ 2>/dev/null; then
            echo "âš ï¸ HTTP requests detected - ensure URL validation is implemented" >> audit-report.md
            echo "   Check that user input is not directly used in URLs" >> audit-report.md
            issues=$((issues + 1))
          else
            echo "âœ… No obvious external HTTP requests detected" >> audit-report.md
          fi
          echo "" >> audit-report.md
          
          # Summary
          echo "### Summary" >> audit-report.md
          echo "" >> audit-report.md
          if [ $issues -eq 0 ]; then
            echo "âœ… OWASP Top 10 compliance looks good!" >> audit-report.md
            echo "status=success" >> $GITHUB_OUTPUT
          elif [ $issues -le 3 ]; then
            echo "âš ï¸ Found $issues potential compliance issues - review recommended" >> audit-report.md
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "ðŸ”´ Found $issues potential compliance issues - action required" >> audit-report.md
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
          echo "" >> audit-report.md

      - name: Generate security summary
        run: |
          echo "---" >> audit-report.md
          echo "" >> audit-report.md
          echo "## Security Audit Summary" >> audit-report.md
          echo "" >> audit-report.md
          echo "- **NPM Audit:** ${{ steps.npm_audit.outputs.status || 'completed' }}" >> audit-report.md
          echo "- **Secret Scan:** ${{ steps.secret_scan.outputs.status || 'completed' }}" >> audit-report.md
          echo "- **OWASP Check:** ${{ steps.owasp_check.outputs.status || 'completed' }}" >> audit-report.md
          echo "" >> audit-report.md
          echo "Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> audit-report.md
          echo "" >> audit-report.md
          echo "---" >> audit-report.md
          echo "" >> audit-report.md
          echo "### Recommendations" >> audit-report.md
          echo "" >> audit-report.md
          echo "1. Review all warnings and address critical/high vulnerabilities" >> audit-report.md
          echo "2. Ensure all secrets are stored in environment variables" >> audit-report.md
          echo "3. Keep dependencies up to date with \`npm update\`" >> audit-report.md
          echo "4. Run \`npm audit fix\` to automatically fix compatible issues" >> audit-report.md
          echo "5. Consider implementing additional security measures from OWASP recommendations" >> audit-report.md

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-report
          path: audit-report.md

      - name: Post report to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('audit-report.md', 'utf8');
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Security Audit Report')
            );
            
            const commentBody = `# ðŸ”’ Security Audit Report\n\n${report}`;
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
            }

      - name: Check if audit failed
        if: steps.npm_audit.outputs.status == 'failed' || steps.owasp_check.outputs.status == 'failed'
        run: |
          echo "::warning::Security audit found issues that require attention"
          # Don't fail the workflow, just warn
          exit 0
